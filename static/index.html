<!DOCTYPE html>
<html>
<head>
  <title>WebRTC PtoP Video Chat</title>  
  <style type="text/css">
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
    }

    #remote-video {
      /*font-size: 0;*/
      position: absolute;
      object-fit: cover;
      width: 100%;
      height: 100%;
      max-width: 100%;
      max-height: 100%;
      z-index: -1;
      
    }

    #local-video {
      width: 240px; 
      height: 180px; 
      position: absolute;
      bottom: 1%;
      right: 2%;
      z-index: 2;
    }

    button {
      position: relative;
      z-index: 2;
    }

    #btn {
      position: absolute;
      top: 3%;
      left: 2%;
      z-index: 2;
    }

  </style>
</head>
<body onload="startVideo()">
  <div id="btn">
    <button type="button" onclick="connect();">Start Video</button>
    <br/>
    <br>
    <button type="button" onclick="stop();">Stop Video</button>
  </div>
  
  <video id="remote-video" autoplay></video>
  <video id="local-video" autoplay></video>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    var localVideo = document.getElementById('local-video');
    var remoteVideo = document.getElementById('remote-video');
    var localStream = null;
    var peerConnection = null;
    var peerStarted = false;
    var mediaConstraints = {'mandatory': {'OfferToReceiveAudio':true, 'OfferToReceiveVideo':true }};


    var iceSeparator = '------ ICE Candidate -------';

    var socket = io();
    var socketReady = false;

    socket.on('connect', onOpened).on('message', onMessage);

    function onOpened(evt) {
      socketReady = true;
    }

    function onMessage(evt) {
      if (evt.type === 'offer') {
        onOffer(evt);
      } else if (evt.type === 'answer' && peerStarted) {
        onAnswer(evt);
      } else if (evt.type === 'candidate' && peerStarted) {
        onCandidate(evt);
      } else if (evt.type === 'user disconnected' && peerStarted) {
        stop();
      }
    }

    function onSDP() {
      var evt = JSON.parse(text);
      if (peerConnection) {
        onAnswer(evt);

      }
      else {
        onOffer(evt);
      }
    }

    //--- multi ICE candidate ---
    function onICE() {
      var arr = text.split(iceSeparator);
      for (var i = 1, len = arr.length; i < len; i++) {
        var evt = JSON.parse(arr[i]);
        onCandidate(evt);
      }
    }

    function onOffer(evt) {
      setOffer(evt);
      sendAnswer(evt);
      peerStarted = true;
    }

    function onAnswer(evt) {
      setAnswer(evt);
    }

    function onCandidate(evt) {
      var candidate = new RTCIceCandidate({sdpMLineIndex:evt.sdpMLineIndex, sdpMid:evt.sdpMid, candidate:evt.candidate});
      peerConnection.addIceCandidate(candidate);
    }

    function sendSDP(sdp) {
      var text = JSON.stringify(sdp);
      socket.json.send(sdp);
    }

    function sendCandidate(candidate) {
      socket.json.send(candidate);
    }

    // ---------------------- video handling -----------------------
    // start local video
    function startVideo() {
      navigator.webkitGetUserMedia({ video: true, audio: false}, function (stream) { // success
        localStream = stream;
        localVideo.src = window.URL.createObjectURL(stream);
        localVideo.play();
        localVideo.volume = 0;}, function (error) { // error
          console.error('An error occurred: [CODE ' + error.code + ']');
          return;
        });

    }

    // ---------------------- connection handling -----------------------
    function prepareNewConnection() {
      var pc_config = {"iceServers":[]};
      var peer = null;
      try {
        peer = new webkitRTCPeerConnection(pc_config);
      } catch (e) {
        console.log("Failed to create peerConnection, exception: " + e.message);
      }

      // send any ice candidates to the other peer
      peer.onicecandidate = function (evt) {
        if (evt.candidate) {
          sendCandidate({type: "candidate", 
            sdpMLineIndex: evt.candidate.sdpMLineIndex,
            sdpMid: evt.candidate.sdpMid,
            candidate: evt.candidate.candidate}
            );
        } 
        else {
          console.log("End of candidates. ------------------- phase=" + evt.eventPhase);
        }
      };

      peer.addStream(localStream);
      peer.addEventListener("addstream", onRemoteStreamAdded, false);
      peer.addEventListener("removestream", onRemoteStreamRemoved, false)

      // when remote adds a stream, hand it on to the local video element
      function onRemoteStreamAdded(event) {
        remoteVideo.src = window.webkitURL.createObjectURL(event.stream);
      }

      // when remote removes a stream, remove it from the local video element
      function onRemoteStreamRemoved(event) {
        remoteVideo.src = "";
      }

      return peer;
    }

    function sendOffer() {
      peerConnection = prepareNewConnection();
      peerConnection.createOffer(function (sessionDescription) { // in case of success
        peerConnection.setLocalDescription(sessionDescription);
        sendSDP(sessionDescription);
      }, function () { // in case of error
        console.log("Create Offer failed");
      }, mediaConstraints);
    }

    function setOffer(evt) {
      if (peerConnection) {
        console.error('peerConnection alreay exist!');
      }
      peerConnection = prepareNewConnection();
      peerConnection.setRemoteDescription(new RTCSessionDescription(evt));
    }

    function sendAnswer(evt) {
      if (! peerConnection) {
        console.error('peerConnection NOT exist!');
        return;
      }

      peerConnection.createAnswer(function (sessionDescription) { // in case of success
        peerConnection.setLocalDescription(sessionDescription);
        sendSDP(sessionDescription);
      }, function () { // in case of error
        console.log("Create Answer failed");
      }, mediaConstraints);
    }

    function setAnswer(evt) {
      if (! peerConnection) {
        console.error('peerConnection NOT exist!');
        return;
      }
      peerConnection.setRemoteDescription(new RTCSessionDescription(evt));
    }

    // -------- handling user UI event -----
    // start the connection upon user request
    function connect() {
      if (!peerStarted && localStream && socketReady) {
        sendOffer();
        peerStarted = true;
        fullScreen();
      } 
      else {
        alert("Local stream not running yet - try again.");
      }
    }

    function stop() {
      peerConnection.close();
      peerConnection = null;
      peerStarted = false;    
    }

    function fullScreen(){
      var width = document.documentElement.clientWidth;
      var height = document.documentElement.clientHeight;

      console.log(width);
      console.log(height);
    }

  </script>
</body>
</html>
